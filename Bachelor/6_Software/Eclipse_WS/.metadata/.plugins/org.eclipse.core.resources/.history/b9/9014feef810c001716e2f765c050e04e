/**
 * @file	CTimerTask.cpp
 * @author	Michael Meindl
 * @date 28.9.2016
 * @brief	Method definitions for CTimerTask.
 */
#include "CTimerTask.h"
#include <iostream>
#include <unistd.h>
#include <sys/time.h>

CTimerTask::CTimerTask() : mRunningSem(false, true),
						   mProxyPtr(nullptr)
{

}
void CTimerTask::init()
{
	std::cout << "[*] Timer-Task : Initializing" << std::endl;
	mProxyPtr = &CProxy::getInstance();
}
void CTimerTask::run()
{
	struct timeval timebegin, timeend;
	long seconds, useconds;

	while(true)
	{
		gettimeofday(&timebegin, (struct timezone*)0);
		mRunningSem.take(true);
		mRunningSem.give();
		usleep(20*1000);
		mProxyPtr->timerTick(true);
		gettimeofday(&timeend, (struct timezone*)0);
		seconds = timeend.tv_sec - timebegin.tv_sec;
		useconds = timeend.tv_usec - timebegin.tv_usec;
		if(useconds < 0)
		{
			useconds += 1000000;
			seconds--;
		}
		std::cout << " Timer-useconds: " << useconds << std::endl;
	}
}
bool CTimerTask::pause(bool waitForever)
{
	std::cout << "[*] Timer-Task : Pausing" << std::endl;
	return mRunningSem.take(waitForever);
}
bool CTimerTask::resume(bool waitForever)
{
	std::cout << "[*] Timer-Task : Resuming" << std::endl;
	mRunningSem.give();
	return true;
}
